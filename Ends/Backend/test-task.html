<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; min-height: 100vh; }
        .task-card { cursor: pointer; transition: transform 0.2s; }
        .task-card:hover { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        
        .priority-high, .priority-urgent { color: #dc3545; font-weight: bold; }
        .priority-medium { color: #ffc107; font-weight: bold; }
        .priority-low { color: #0d6efd; font-weight: bold; }

        #login-section {
            height: 100vh; display: flex; align-items: center; justify-content: center;
        }
    </style>
</head>
<body>

<!-- LOGIN SECTION -->
<div id="login-section" class="container">
    <div class="card shadow" style="width: 100%; max-width: 400px;">
        <div class="card-body p-4">
            <h3 class="text-center mb-4">Task Manager</h3>
            <div id="login-error" class="alert alert-danger d-none"></div>
            <form onsubmit="handleLogin(event)">
                <div class="mb-3">
                    <label class="form-label">Username</label>
                    <input type="text" id="username" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Password</label>
                    <input type="password" id="password" class="form-control" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">Login</button>
            </form>
        </div>
    </div>
</div>

<!-- APP SECTION -->
<div id="app-section" class="d-none">
    <nav class="navbar navbar-dark bg-dark mb-4">
        <div class="container">
            <span class="navbar-brand mb-0 h1">Django Tasks</span>
            <div class="d-flex align-items-center gap-3">
                <span class="text-white small" id="user-display"></span>
                <button class="btn btn-outline-warning btn-sm" onclick="openPasswordModal()">Change Password</button>
                <button class="btn btn-outline-light btn-sm" onclick="logout()">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <ul class="nav nav-pills" id="statusFilters">
                <li class="nav-item"><a class="nav-link active" href="#" onclick="filterTasks('all', this)">All</a></li>
                <li class="nav-item"><a class="nav-link" href="#" onclick="filterTasks('todo', this)">To Do</a></li>
                <li class="nav-item"><a class="nav-link" href="#" onclick="filterTasks('in_progress', this)">In Progress</a></li>
                <li class="nav-item"><a class="nav-link" href="#" onclick="filterTasks('done', this)">Done</a></li>
            </ul>
            <button class="btn btn-success" onclick="openCreateModal()">+ New Task</button>
        </div>

        <div id="tasks-container" class="row g-4"></div>
    </div>
</div>

<!-- VIEW TASK MODAL -->
<div class="modal fade" id="taskModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Task Title</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-8">
                        <h6>Description</h6>
                        <p id="modalDescription" class="text-muted">No description.</p>
                        <div class="mt-3 row">
                            <div class="col-6"><small class="text-muted"><strong>Start:</strong> <span id="modalStart"></span></small></div>
                            <div class="col-6"><small class="text-muted"><strong>Group:</strong> <span id="modalGroup"></span></small></div>
                        </div>
                    </div>
                    <div class="col-md-4 border-start">
                        <div class="mb-2"><strong>Priority:</strong> <span id="modalPriority"></span></div>
                        <div class="mb-2"><strong>Status:</strong> <span id="modalStatus"></span></div>
                        <div class="mb-2"><strong>Due:</strong> <span id="modalDue"></span></div>
                        <div class="mb-2"><strong>Assigned to:</strong> <span id="modalAssigned"></span></div>
                    </div>
                </div>
                
                <div class="d-flex gap-2 mb-3">
                    <button class="btn btn-outline-primary btn-sm" onclick="switchToEditMode()">Edit Task</button>
                    <button class="btn btn-outline-danger btn-sm" onclick="deleteTask()">Delete Task</button>
                </div>

                <hr>
                <h6>Comments</h6>
                <div id="modalComments" class="mb-3" style="max-height: 200px; overflow-y: auto; background: #f1f1f1; padding: 10px; border-radius: 5px;"></div>
                <div class="input-group">
                    <input type="text" id="newCommentInput" class="form-control" placeholder="Write a comment..." onkeyup="if(event.key === 'Enter') postComment()">
                    <button class="btn btn-primary" onclick="postComment()">Post</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- CREATE / EDIT FORM MODAL -->
<div class="modal fade" id="formModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="formModalTitle">New Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="taskForm" onsubmit="handleSaveTask(event)">
                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input type="text" id="formTitle" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea id="formDescription" class="form-control" rows="3"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Group</label>
                        <select id="formGroup" class="form-select">
                            <option value="">-- No Group --</option>
                        </select>
                    </div>

                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label">Priority</label>
                            <select id="formPriority" class="form-select">
                                <option value="low">Low</option>
                                <option value="medium">Medium</option>
                                <option value="high">High</option>
                                <option value="urgent">Urgent</option>
                            </select>
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label">Status</label>
                            <select id="formStatus" class="form-select">
                                <option value="todo">To Do</option>
                                <option value="in_progress">In Progress</option>
                                <option value="done">Done</option>
                                <option value="archived">Archived</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label">Start Date</label>
                            <input type="date" id="formStartDate" class="form-control">
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label">Due Date</label>
                            <input type="date" id="formDueDate" class="form-control">
                        </div>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">Save Task</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- CHANGE PASSWORD MODAL -->
<div class="modal fade" id="passwordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Change Password</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="pwd-msg" class="alert d-none"></div>
                <form onsubmit="handleChangePassword(event)">
                    <div class="mb-3">
                        <label class="form-label">Old Password</label>
                        <input type="password" id="oldPwd" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">New Password</label>
                        <input type="password" id="newPwd" class="form-control" required>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-warning">Update Password</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- CONFIGURATION ---
    const API_BASE = 'http://127.0.0.1:8000/api'; 
    
    // --- STATE ---
    let allTasks = [];
    let currentTaskId = null;
    let isEditing = false; 

    document.addEventListener('DOMContentLoaded', () => {
        checkAuth();
    });

    // --- AUTHENTICATION ---
    function checkAuth() {
        const token = localStorage.getItem('token');
        const username = localStorage.getItem('username');
        if (token) {
            document.getElementById('login-section').classList.add('d-none');
            document.getElementById('app-section').classList.remove('d-none');
            document.getElementById('user-display').innerText = `Hello, ${username}`;
            loadTasks();
            loadGroups(); 
        } else {
            document.getElementById('login-section').classList.remove('d-none');
            document.getElementById('app-section').classList.add('d-none');
        }
    }

    async function handleLogin(e) {
        e.preventDefault();
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;
        const err = document.getElementById('login-error');
        try {
            const res = await fetch(`${API_BASE}/login/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: u, password: p })
            });
            if (!res.ok) throw new Error();
            const data = await res.json();
            localStorage.setItem('token', data.token);
            localStorage.setItem('user_id', data.user_id);
            localStorage.setItem('username', data.username);
            err.classList.add('d-none');
            checkAuth();
        } catch (e) {
            err.innerText = "Login failed.";
            err.classList.remove('d-none');
        }
    }

    function logout() {
        localStorage.clear();
        checkAuth();
    }

    // --- API WRAPPER ---
    async function authFetch(url, options = {}) {
        const token = localStorage.getItem('token');
        const headers = {
            'Content-Type': 'application/json',
            'Authorization': `Token ${token}`,
            ...options.headers
        };
        const separator = url.includes('?') ? '&' : '?';
        let finalUrl = url;
        if (!options.method || options.method === 'GET') {
            finalUrl = `${url}${separator}_t=${Date.now()}`;
        }
        const res = await fetch(finalUrl, { ...options, headers });
        if (res.status === 401) { logout(); return null; }
        return res;
    }

    // --- LOAD GROUPS ---
    async function loadGroups() {
        try {
            const res = await authFetch(`${API_BASE}/groups/`);
            if (res && res.ok) {
                const groups = await res.json();
                const select = document.getElementById('formGroup');
                select.innerHTML = '<option value="">-- No Group --</option>';
                groups.forEach(g => {
                    const option = document.createElement('option');
                    option.value = g.id;
                    option.innerText = g.groupname || g.name || g.title || `Group #${g.id}`;
                    select.appendChild(option);
                });
            }
        } catch (e) { console.error("Failed to load groups", e); }
    }

    // --- LOAD TASKS ---
    async function loadTasks() {
        const container = document.getElementById('tasks-container');
        if (container.innerHTML === '') {
            container.innerHTML = '<div class="col-12 text-center"><div class="spinner-border text-primary"></div></div>';
        }

        try {
            const res = await authFetch(`${API_BASE}/tasks/`);
            if (res && res.ok) {
                const data = await res.json();
                allTasks = Array.isArray(data) ? data : data.results;
                renderTasks(allTasks);
            }
        } catch (e) {
            container.innerHTML = `<div class="text-danger text-center">Error loading tasks</div>`;
        }
    }

    function renderTasks(tasks) {
        const container = document.getElementById('tasks-container');
        container.innerHTML = '';
        
        // Frontend Filtering
        const activeTasks = tasks.filter(t => t.active === true);

        if (!activeTasks || activeTasks.length === 0) {
            container.innerHTML = '<div class="text-center text-muted mt-5">No tasks found. Create one!</div>';
            return;
        }

        activeTasks.forEach(task => {
            const assignee = task.assigned_to ? task.assigned_to.username : 'Unassigned';
            const card = `
                <div class="col-md-4">
                    <div class="card h-100 task-card" onclick="openTaskModal(${task.id})">
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="badge bg-secondary">${formatStatus(task.status)}</span>
                                <span class="priority-${task.priority} text-uppercase small">${task.priority}</span>
                            </div>
                            <h5 class="card-title">${task.title}</h5>
                            <p class="card-text text-muted small text-truncate">${task.description || ''}</p>
                            <div class="d-flex justify-content-between align-items-center mt-3 border-top pt-2">
                                <small class="text-muted">ðŸ‘¤ ${assignee}</small>
                                <small class="text-muted">ðŸ“… ${task.due_date || 'None'}</small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML += card;
        });
    }

    function formatStatus(s) {
        return s.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
    }

    function filterTasks(status, el) {
        document.querySelectorAll('#statusFilters .nav-link').forEach(l => l.classList.remove('active'));
        el.classList.add('active');
        if (status === 'all') renderTasks(allTasks);
        else renderTasks(allTasks.filter(t => t.status === status));
    }

    // --- MODAL HANDLING ---
    // Use getOrCreateInstance to prevent duplicates or closing errors
    function getTaskModal() {
        return bootstrap.Modal.getOrCreateInstance(document.getElementById('taskModal'));
    }
    function getFormModal() {
        return bootstrap.Modal.getOrCreateInstance(document.getElementById('formModal'));
    }

    async function openTaskModal(id) {
        currentTaskId = id;
        const task = allTasks.find(t => t.id === id);
        if (!task) return;

        // Populate Modal Fields
        document.getElementById('modalTitle').innerText = task.title;
        document.getElementById('modalDescription').innerText = task.description || 'No description.';
        document.getElementById('modalPriority').innerText = task.priority.toUpperCase();
        document.getElementById('modalStatus').innerText = formatStatus(task.status);
        document.getElementById('modalStart').innerText = task.start_date || 'N/A';
        document.getElementById('modalDue').innerText = task.due_date || 'N/A';
        document.getElementById('modalAssigned').innerText = task.assigned_to ? task.assigned_to.username : 'Unassigned';
        
        let gName = 'None';
        if (task.group_detail) {
            gName = task.group_detail.groupname || task.group_detail.name || task.group_detail.title || `Group #${task.group_detail.id}`;
        }
        document.getElementById('modalGroup').innerText = gName;

        // Load comments
        loadComments(id);

        // Show Modal
        getTaskModal().show();
    }

    // --- FORM LOGIC ---
    function openCreateModal() {
        isEditing = false;
        currentTaskId = null;
        document.getElementById('formModalTitle').innerText = "New Task";
        document.getElementById('taskForm').reset();
        getFormModal().show();
    }

    function switchToEditMode() {
        // Hide Detail View
        getTaskModal().hide();

        isEditing = true;
        const task = allTasks.find(t => t.id === currentTaskId);
        
        document.getElementById('formModalTitle').innerText = "Edit Task";
        document.getElementById('formTitle').value = task.title;
        document.getElementById('formDescription').value = task.description;
        document.getElementById('formPriority').value = task.priority;
        document.getElementById('formStatus').value = task.status;
        document.getElementById('formDueDate').value = task.due_date || '';
        document.getElementById('formStartDate').value = task.start_date || ''; 
        
        let groupId = "";
        if (task.group_detail && task.group_detail.id) {
            groupId = task.group_detail.id;
        } else if (task.group) {
            groupId = task.group;
        }
        document.getElementById('formGroup').value = groupId;

        getFormModal().show();
    }

    async function handleSaveTask(e) {
        e.preventDefault();
        
        const getVal = (id) => {
            const v = document.getElementById(id).value;
            return v === "" ? null : v;
        };

        const payload = {
            title: document.getElementById('formTitle').value,
            description: document.getElementById('formDescription').value,
            priority: document.getElementById('formPriority').value,
            status: document.getElementById('formStatus').value,
            start_date: getVal('formStartDate'),
            due_date: getVal('formDueDate'),
            group: getVal('formGroup')
        };
        
        try {
            let res;
            if (isEditing) {
                res = await authFetch(`${API_BASE}/tasks/${currentTaskId}/`, {
                    method: 'PATCH',
                    body: JSON.stringify(payload)
                });
            } else {
                payload.created_by_userid = localStorage.getItem('user_id');
                res = await authFetch(`${API_BASE}/tasks/`, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
            }

            if (res && res.ok) {
                const savedTask = await res.json();
                
                // 1. Update LOCAL Array Immediately (No fetch needed)
                if (isEditing) {
                    const idx = allTasks.findIndex(t => t.id === currentTaskId);
                    if (idx !== -1) allTasks[idx] = savedTask;
                } else {
                    allTasks.unshift(savedTask);
                }
                
                // 2. Refresh Grid Background
                renderTasks(allTasks);

                // 3. Hide Form
                getFormModal().hide();

                // 4. If editing, Re-Open Detail View IMMEDIATELY
                if (isEditing) {
                    openTaskModal(currentTaskId);
                }
            } else {
                const errData = await res.json();
                alert("Error saving task: " + JSON.stringify(errData));
            }
        } catch (err) {
            console.error(err);
        }
    }

    async function deleteTask() {
        if (!confirm("Are you sure you want to delete this task?")) return;
        try {
            const res = await authFetch(`${API_BASE}/tasks/${currentTaskId}/`, {
                method: 'DELETE'
            });
            if (res && res.ok) {
                getTaskModal().hide();
                // Remove from local array immediately
                allTasks = allTasks.filter(t => t.id !== currentTaskId);
                renderTasks(allTasks);
            } else {
                alert("Failed to delete task.");
            }
        } catch (err) { console.error(err); }
    }

    // --- COMMENTS ---
    async function loadComments(taskId) {
        const container = document.getElementById('modalComments');
        container.innerHTML = '<small>Loading...</small>';
        try {
            const res = await authFetch(`${API_BASE}/comments/`);
            const data = await res.json();
            const all = Array.isArray(data) ? data : data.results;

            const filtered = all.filter(c => {
                const commentTaskId = c.task !== undefined ? c.task : (c.task_detail ? c.task_detail.id : null);
                return commentTaskId === taskId;
            });
            
            if (filtered.length === 0) {
                container.innerHTML = '<p class="text-muted small">No comments.</p>';
                return;
            }
            let html = '<ul class="list-group list-group-flush">';
            filtered.forEach(c => {
                const u = c.user_detail ? c.user_detail.username : 'Unknown';
                const d = new Date(c.created_at).toLocaleString();
                html += `<li class="list-group-item bg-transparent">
                    <div class="d-flex justify-content-between"><strong>${u}</strong><span class="text-muted small">${d}</span></div>
                    <p class="mb-0 small">${c.content}</p>
                </li>`;
            });
            html += '</ul>';
            container.innerHTML = html;
        } catch (e) {
            container.innerHTML = '<small class="text-danger">Error loading comments</small>';
        }
    }

    async function postComment() {
        const input = document.getElementById('newCommentInput');
        if (!input.value || !currentTaskId) return;
        try {
            await authFetch(`${API_BASE}/comments/`, {
                method: 'POST',
                body: JSON.stringify({
                    task: currentTaskId,
                    user: localStorage.getItem('user_id'),
                    content: input.value,
                    active: true
                })
            });
            input.value = '';
            loadComments(currentTaskId);
            // Note: We intentionally DO NOT close the modal here.
        } catch (e) { alert("Error posting comment"); }
    }

    // --- CHANGE PASSWORD ---
    function openPasswordModal() {
        document.getElementById('oldPwd').value = '';
        document.getElementById('newPwd').value = '';
        document.getElementById('pwd-msg').className = 'alert d-none';
        bootstrap.Modal.getOrCreateInstance(document.getElementById('passwordModal')).show();
    }

    async function handleChangePassword(e) {
        e.preventDefault();
        const oldP = document.getElementById('oldPwd').value;
        const newP = document.getElementById('newPwd').value;
        const msgDiv = document.getElementById('pwd-msg');

        try {
            const res = await authFetch(`${API_BASE}/change-password/`, {
                method: 'PUT',
                body: JSON.stringify({ old_password: oldP, new_password: newP })
            });

            const data = await res.json();

            if (res.ok) {
                msgDiv.className = 'alert alert-success';
                msgDiv.innerText = "Password updated!";
                setTimeout(() => {
                    bootstrap.Modal.getOrCreateInstance(document.getElementById('passwordModal')).hide();
                }, 1500);
            } else {
                msgDiv.className = 'alert alert-danger';
                msgDiv.innerText = data.error || "Failed to update.";
            }
        } catch (err) {
            msgDiv.className = 'alert alert-danger';
            msgDiv.innerText = "Server error.";
        }
    }
</script>
</body>
</html>